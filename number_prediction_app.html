<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Predict number app</title>
    <!-- add Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-aFq/bzH65dt+w6FI2ooMVUpc+21e0SRygnTpmBvdBgSdnuTN7QbdgL+OapgHtvPp"
      crossorigin="anonymous"
    />
  </head>
  <body>
    <div class="container">
      <div class="row justify-content-center mt-5">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header text-center">
              Draw number(s) and predict
            </div>
            <div class="card-body">
              <canvas
                id="canvas"
                width="400"
                height="125"
                style="border: 1px solid #000000"
                class="mx-auto d-block mb-2"
              ></canvas>
              <div class="d-flex justify-content-center gap-2">
                <button class="btn btn-primary mr-2" onclick="predictCanvas()">
                  Predict
                </button>
                <button class="btn btn-danger" onclick="clearCanvas()">
                  Clear canvas
                </button>
              </div>
              <strong id="canvasResult" class="mt-2"></strong>
            </div>
          </div>
        </div>
      </div>

      <div class="row justify-content-center mt-5">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header text-center">
              Upload image with number(s) for prediction
            </div>
            <div class="card-body">
              <div class="text-center mb-2">
                <img
                  id="imagePreview"
                  class="img-thumbnail"
                  style="display: none"
                />
              </div>
              <input
                class="form-control mb-2"
                type="file"
                onchange="predictUploadedImage()"
              />
              <strong id="imageUploadResult" class="mt-2"></strong>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- add Bootstrap JS -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-qKXV1j0HvMUeCBQ+QVp7JcfGl760yU08IQ+GpUo5hlbpg51QRiuqHAJz8+BrxE/N"
      crossorigin="anonymous"
    ></script>
    <script>
      var canvas = document.getElementById("canvas");
      var ctx = canvas.getContext("2d");
      ctx.fillStyle = "white"; // set background color to white
      ctx.fillRect(0, 0, canvas.width, canvas.height); // fill entire canvas with white
      ctx.lineWidth = 5; // set line width to 7 pixels
      var isDrawing = false;
      var lastX, lastY;

      canvas.addEventListener("mousedown", startDrawing);
      canvas.addEventListener("mousemove", drawOnCanvas);
      canvas.addEventListener("mouseup", stopDrawing);

      function startDrawing(e) {
        isDrawing = true;
        [lastX, lastY] = [e.offsetX, e.offsetY];
      }

      function drawOnCanvas(e) {
        if (!isDrawing) return;
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(e.offsetX, e.offsetY);
        ctx.stroke();
        [lastX, lastY] = [e.offsetX, e.offsetY];
      }

      function stopDrawing() {
        isDrawing = false;
      }

      function predictUploadedImage() {
        var preview = document.getElementById("imagePreview");
        var file = document.querySelector("input[type=file]").files[0];
        var reader = new FileReader();

        reader.onloadend = function () {
          preview.src = reader.result;
          preview.style.display = "inline";
          if (preview.src != "") {
            predict(preview.src, "image");
          }
        };

        if (file) {
          reader.readAsDataURL(file);
        } else {
          preview.src = "";
          preview.style.display = "none";
        }
      }

      function predictCanvas() {
        predict(canvas.toDataURL("image/png"), "canvas");
      }

      function predict(img, predictionFor) {
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "http://localhost:5000/predict", true);
        xhr.onreadystatechange = function () {
          if (xhr.readyState === 4 && xhr.status === 200) {
            var result = JSON.parse(xhr.responseText);
            if (predictionFor === "canvas") {
              document.getElementById("canvasResult").innerHTML =
                "Prediction: " + result.class_ids;
            } else {
              document.getElementById("imageUploadResult").innerHTML =
                "Prediction: " + result.class_ids;
            }
          }
        };

        var formData = new FormData();
        var blob = dataURItoBlob(img);
        formData.append("image", blob, "image.png");

        xhr.send(formData);
      }

      // Helper function to convert a data URI to a Blob object
      function dataURItoBlob(dataURI) {
        var byteString = atob(dataURI.split(",")[1]);
        var ab = new ArrayBuffer(byteString.length);
        var ia = new Uint8Array(ab);
        for (var i = 0; i < byteString.length; i++) {
          ia[i] = byteString.charCodeAt(i);
        }
        return new Blob([ab], { type: "image/png" });
      }

      function clearCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "white";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        document.getElementById("canvasResult").innerHTML = "";
      }
    </script>
  </body>
</html>
